services:
  # Database for the Web UI (Campaigns, Users, Findings)
  postgres:
    image: postgres:17
    environment:
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
      POSTGRES_DB: fuzztest
    ports:
      - "5432:5432"
    volumes:
      - db-data:/var/lib/postgresql/data

  # The Go Service that runs the actual Fuzz tests
  runner:
    build:
      context: ./runner
      dockerfile: Dockerfile
    ports:
      - "8080:8080"
    volumes:
      # CRITICAL: Allow runner to spawn sibling containers for fuzzing
      - /var/run/docker.sock:/var/run/docker.sock
      # Shared volume for crash artifacts if needed later
      - fuzz-artifacts:/app/artifacts 

  # The SvelteKit Web Dashboard
  web:
    build:
      context: ./web
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    depends_on:
      - postgres
      - runner
    environment:
      DATABASE_URL: postgres://user:password@postgres:5432/fuzztest
      RUNNER_API_URL: http://runner:8080

volumes:
  db-data:
  fuzz-artifacts:
